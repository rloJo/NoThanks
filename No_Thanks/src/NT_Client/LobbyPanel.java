package NT_Client;

import java.awt.CardLayout;
import java.awt.Color;
import java.awt.Container;
import java.awt.Font;
import java.awt.TextArea;
import java.awt.TextField;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.Socket;
import java.util.StringTokenizer;
import java.util.Vector;

import javax.swing.DefaultListModel;
import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.WindowConstants;

import common.Msg;

public class LobbyPanel extends JPanel {

	private static final long serialVersionUID = 1L;
	private JFrame mainFrame;
	private LobbyPanel lobbyPanel;
	private InGamePanel IngamePanel;
	private Container container;
	private CardLayout cardLayout;
	private CreateRoomFrame createRoomFrame;
	
	private JLabel waitingroominfoLabel;
	public Vector<NTRoom> ntRooms = new Vector<> ();
	private JList<String> userlist; 
	private DefaultListModel<String> userModel;
	private JList<String> roomlist;
	private DefaultListModel<String> roomModel;
	private JLabel chatinfoLabel;
	private JScrollPane scrollPane;
	private TextArea textArea;
	private JLabel userinfoLabel;
	private TextField chatTextField;
	private JButton sendBtn;
	private JButton CreateBtn;
	
	private static final int BUF_LEN = 128;
	
	public String userName;
	private int roomId;
	private Socket socket;
    private ObjectInputStream ois;
	private ObjectOutputStream oos;
    

    
	public LobbyPanel(Container container, JFrame mainFrame,String userName, String ip_addr, String port_num) {
		SendMsgBtnClick sendAction = new  SendMsgBtnClick();
		CreateRoomBtnClick createAction = new CreateRoomBtnClick();
		
		lobbyPanel = this;
		this.mainFrame = mainFrame;
		this.container = container;
		this.cardLayout = (CardLayout) container.getLayout();
		
		
		
		setBackground(new Color(240, 240, 240));
		setLayout(null);
		
		this.userName = userName;
		waitingroominfoLabel = new JLabel("방번호    방제목              인원수     게임 모드     방 상태");
		waitingroominfoLabel.setBackground(new Color(240, 240, 240));
		waitingroominfoLabel.setFont(new Font("굴림", Font.BOLD, 29));
		waitingroominfoLabel.setBounds(96, 10, 800, 45);
		add(waitingroominfoLabel);
		
		roomModel = new DefaultListModel<String>();
		roomlist = new JList<String>(roomModel);
		roomlist.setBounds(96, 52, 800, 244);
		add(roomlist);
		
		chatinfoLabel = new JLabel("전체 채팅");
		chatinfoLabel.setFont(new Font("굴림", Font.BOLD, 24));
		chatinfoLabel.setBounds(96, 306, 119, 33);
		add(chatinfoLabel);
		
		
		scrollPane = new JScrollPane();
		scrollPane.setBounds(96, 336, 533, 183);
		add(scrollPane);
		
		textArea = new TextArea();
		textArea.setEditable(false);
		scrollPane.setViewportView(textArea);
		
		userinfoLabel = new JLabel("유저 목록");
		userinfoLabel.setFont(new Font("굴림", Font.BOLD, 24));
		userinfoLabel.setBounds(641, 306, 119, 33);
		add(userinfoLabel);
	
		chatTextField = new TextField();
		chatTextField.setBounds(96, 525, 456, 31);
		add(chatTextField);
		chatTextField.addActionListener(sendAction);
        chatTextField.requestFocus();
		     
		sendBtn = new JButton("전송");
		sendBtn.setFont(new Font("굴림", Font.BOLD, 18));
		sendBtn.setBounds(558, 529, 71, 31);
		add(sendBtn);
		sendBtn.addActionListener(sendAction);
		
		userModel = new DefaultListModel<String>();
		userlist = new JList<String>(userModel);
		userlist.setBounds(651, 336, 245, 183);
		add(userlist);
		
		AppendText("User " + userName + " connecting " + ip_addr + " " + port_num + "\n");
		this.userName = userName;
		
		CreateBtn = new JButton("방 생성");
		CreateBtn.setFont(new Font("굴림", Font.BOLD, 18));
		CreateBtn.setBounds(650, 525, 97, 32);
		add(CreateBtn);
		CreateBtn.addActionListener(createAction);

        try {
            socket = new Socket(ip_addr, Integer.parseInt(port_num));
            oos = new ObjectOutputStream(socket.getOutputStream());
            oos.flush();
            ois = new ObjectInputStream(socket.getInputStream());

           
            Msg loginMsg = new Msg(userName,"100", "login");
            sendObject(loginMsg);
            updateRoomList();
            
            ListenNetwork net = new ListenNetwork();
            net.start();
            
               
        } catch (NumberFormatException | IOException e) {
            e.printStackTrace();
        }
	}
	
	// keyboard enter key를 누르거나 전송 버튼 클릭하면 서버로 전송 
	class SendMsgBtnClick implements ActionListener // 내부클래스로 액션 이벤트 처리 클래스
	{
		@Override
		public void actionPerformed(ActionEvent e) {
			 updateRoomList();
			// Send button을 누르거나 메시지 입력하고 Enter key 치면
			if (e.getSource() == sendBtn || e.getSource() == chatTextField) {
				String msg = null;
				msg = String.format("[%s] %s\n", userName, chatTextField.getText());
				//SendMessage(msg);
				chatTextField.setText(""); // 메세지를 보내고 나면 메세지 쓰는창을 비운다.
				chatTextField.requestFocus(); // 메세지를 보내고 커서를 다시 텍스트 필드로 위치시킨다
				if (msg.contains("/exit")) // 종료 처리
					System.exit(0);
			}
		}
	}
	
	// 방 생성 버튼 누르면 생성 창 뜨게함
	class CreateRoomBtnClick implements ActionListener
	{

		@Override
		public void actionPerformed(ActionEvent e) {
			createRoomFrame = new CreateRoomFrame(lobbyPanel);
			createRoomFrame.setVisible(true);
		}
	}
	
	//CreateRoomFrame에서 방 만들기 버튼을 누르면 실행되는 함수
	public void createRoom(String roomName, Boolean isPass, String passWd, int roomType)
	{
		IngamePanel = new InGamePanel(container, lobbyPanel);
		container.add(IngamePanel,"IngamePanel");
		cardLayout.show(container, "IngamePanel");
		
		Msg msg = new Msg(userName,"200","방 생성");
		msg.setUserName(userName);
		msg.setRoomName(roomName);
		msg.setIsPass(isPass);
		msg.setPassWd(passWd);
		msg.setMode(roomType);
		sendObject(msg);
		System.out.println("응 전송했어~");
		
		IngamePanel.p1_nameLabel.setText(userName);
	}
	
	//server에 메세지 객체(Msg)를 전송하는 메소드 
	public void sendObject(Object obj)
	{
		try {
			if(obj instanceof Msg) {
				oos.writeObject(obj);
			}
		} catch (Exception e) {
			System.err.println("sendObject error: " + e.getMessage());
	        e.printStackTrace();
		}
	}
	
	public void sendAllChatMessage(String message) {
		try {
			Msg msg = new Msg(userName,"400",message);
			msg.setRoomId(IngamePanel.roomId);
			oos.writeObject(msg);
		} catch (Exception e) { 
			System.out.println("sendChatMessage error");
		}
	}
	
	//server에 게임 내 유저끼리의 채팅 메시지 전송 메소드
	public void sendChatMessage(String message) {
		try {
			Msg msg = new Msg(userName,"400",message);
			msg.setRoomId(IngamePanel.roomId);
			oos.writeObject(msg);
		} catch (Exception e) { 
			System.out.println("sendChatMessage error");
		}
	}
	
    // 화면에 출력
    public void AppendText(String msg) {
        textArea.append(msg);
        textArea.setCaretPosition(textArea.getText().length());
    }


    
    //클라이언트의 roomList를 업데이트 하기 위한 메소드
    public void updateRoomList() {
		for(int i=0; i<ntRooms.size(); i++) {
			NTRoom room = ntRooms.get(i);
			String status = "";
			if(room.getStatus() == 0) status = "대기 중";
			else status = "게임 중";
			String str = String.format("%-16s%-5d%-9s", room.getRoomName(), room.getUserCount(), status);
			roomModel.set(i, str);
		}
	}
    
 // Server Message를 수신해서 화면에 표시
    class ListenNetwork extends Thread {
    	public ListenNetwork() {
    		Msg roomList = new Msg(userName, "210", "roomList");
    		sendObject(roomList);
    	}
    	
        public void run() {
            while (true) {
                try {
                	// 받은 메세지의 code에 따라 다른 행동 수행
                    Object obj = null;
                    String message = null;
                    Msg msg;
                    try {
                    	obj = ois.readObject();
                    } catch(ClassNotFoundException e) {
                    	e.printStackTrace();
                    	break;
                    }
                    
                    if(obj == null)
                    	break;
                    
                    if(obj instanceof Msg) {
                    	msg = (Msg)obj;
                    } else {
                    	continue;
                    }
                    
                    /* ---------------- code 분류 ----------------------------*/
                    /*	100 - 로그인
                     *  200 - 방 생성 정보를 담는다.
                     *  201 - 생성된 방에 접속했다는 정보.
                     *  202 - 방에 인원이 꽉차 접속하지 못했다는 정보
                     *  210 - 서버로 부터 전체 방 목록이 전송된 경우
                     *  211 - 서버로 부터 전체 접속자 목록이 전송된 경우
                     *  300 - 게임 시작
                     *  301 - 해당 카드를 먹는다는 정보 전달
                     *  302 - 해당 카드 먹기 거부 정보 전달
                     *  320 - 경기가 끝나고 승자가 정보 전달
                     *  400 -
                     *  420 - 게임 종료 
                     *  430 - 종료된 방 삭제
                     *  500 - 해당 방 채팅
                     *  510 - 해당 방 user 표시
                     */
                    
                    switch (msg.getCode())
                    {
                    case "200":
                    	int roomId = msg.getRoomId();
                    	String roomName = msg.getRoomName();
                    	int userCount = msg.getUserCount();
                    	boolean IsPass = msg.getIsPass();
                    	String gameMode = (msg.getMode() == 0) ? "normal" : "special"; 
                    	String status = (msg.getStatus() == 0) ? "대기 중" : "게임 중"; 
                    	NTRoom newRoom = new NTRoom(roomId);
                    	ntRooms.addElement(newRoom);
                    	
                    	String roomInfo = String.format("%-3s %-8s %-5d %-8s %-6s"
                    			,msg.getRoomId()
                    			,msg.getRoomName()
                    			,msg.getUserCount()
                    			,msg.getMode()
                    			,status);
                    	roomModel.addElement(roomInfo);
                    	break;
                    	
                    	
                    case "201":
                    	lobbyPanel.roomId = msg.getRoomId();
                    	for(int i=0; i<ntRooms.size();i++)
                    	{
                    		NTRoom room = ntRooms.get(i);
                    		if(room.getRoomId() == msg.getRoomId())
                    			room.users.add(lobbyPanel);
                    	}
                    	
                    	IngamePanel = new InGamePanel(container, lobbyPanel);
                    	IngamePanel.roomId = msg.getRoomId();
                    	container.add(IngamePanel,"gamePanel");
                    	IngamePanel.role = msg.getRole();
                    	
                    	if(msg.getRole() == msg.p1) {
                    		IngamePanel.p1_nameLabel.setText(msg.getUserName());
                    	}
                    	
                    	if(msg.getRole() == msg.p2) {
                    		IngamePanel.p2_nameLabel.setText(msg.getUserName());
                    	}
                    	
                    	if(msg.getRole() == msg.p3) {
                    		IngamePanel.p3_nameLabel.setText(msg.getUserName());
                        }  
                    	
                    	if(msg.getRole() == msg.p4) {
                    		IngamePanel.p4_nameLabel.setText(msg.getUserName());
                        }
                    	
                    	//mainFrame.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);
                    	cardLayout.show(container, "IngamePanel");
                    	IngamePanel.roomUserList();
                    	break;
                    	
                    	// 게임 방에 접속 할 수 없는 경우
					case "202":
						JOptionPane.showMessageDialog(mainFrame, msg.getData(), "error", JOptionPane.ERROR_MESSAGE);
						break;
						
					case "210" :
						int roomId2 = msg.getRoomId(); // 방 ID
						String roomName2 = msg.getRoomName(); // 방 이름
						int peopleCount2 = msg.getUserCount(); // 방 인원 수
						
						NTRoom newRoom2 = new NTRoom(roomId2); // 새로운 방 만들기
						newRoom2.setRoomName(roomName2);
						newRoom2.setUserCount(peopleCount2);
						newRoom2.setStatus(msg.getStatus());
						newRoom2.setIsPass(msg.getIsPass());
						ntRooms.add(newRoom2); // 방 리스트에 추가
						
						String s = "";
						if(newRoom2.getStatus() == 0) s = "게임 대기 중";
						else s = "게임 중";
						String roomStr2 = String.format("%-3s %-8s %d/4 %-8s %-6s"
                    			,msg.getRoomId()
                    			,msg.getRoomName()
                    			,msg.getUserCount()
                    			,msg.getMode()
                    			,s);
						roomModel.addElement(roomStr2); 
						
						roomlist.setModel(roomModel);
						roomlist.repaint();
						break;
						
					case "211":
                    	String str = msg.getData();
                    	StringTokenizer tokenizer = new StringTokenizer(str);
                    	userModel.removeAllElements();
                    	while(tokenizer.hasMoreTokens()) {
                    		String user = tokenizer.nextToken();
                    		userModel.addElement(user);
                    	}
                    	break;					
						
					case "300":
						// 자신이 플레이어인 경우
						if(IngamePanel != null && msg.getRoomId() == IngamePanel.roomId) {
							String userNames = msg.getData();
							StringTokenizer st = new StringTokenizer(userNames);
							if(st.hasMoreTokens())							
								IngamePanel.p1_nameLabel.setText(st.nextToken());
							if(st.hasMoreTokens())
								IngamePanel.p2_nameLabel.setText(st.nextToken());
							if(st.hasMoreTokens())
								IngamePanel.p3_nameLabel.setText(st.nextToken());
							if(st.hasMoreTokens())
								IngamePanel.p4_nameLabel.setText(st.nextToken());
							
							if(IngamePanel.order == 1) { // 순서가 1 인경우 
								IngamePanel.status = 1; // status 1로 설정하여 카드를 먹을 수 있는 상태로 설정
							}
						}
						// 플레이어가 아니면 방 리스트 상태 업데이트만 해주면 됨
						else {
							for(int i=0; i<ntRooms.size(); i++) {
								if(ntRooms.get(i).getRoomId() == msg.getRoomId())
									ntRooms.get(i).setStatus(1);
							}
						}
						break;
                    	
                    case "400":
						IngamePanel.AppendChat(msg.getUserName(), msg.getData());
						break;
                                     	         
                    
                    }
                }
                 catch (IOException e) {
                    AppendText("오류 발생");
                    try {
                        oos.close();
                        ois.close();
                        socket.close();
                        break;
                    } catch (Exception ee) {
                        break;
                    }
                } //c
            }//w
        }//run
    }
}
  